{% extends "base.html" %}
{% block content %}

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<!-- ================= TOP NAVBAR ================= -->
<nav class="navbar navbar-dark bg-dark px-3">
  <button class="btn btn-outline-light" id="toggleBtn">‚ò∞</button>
  <span class="navbar-brand ms-3">Complaint Dashboard</span>

  <ul class="navbar-nav flex-row ms-auto gap-3">
    <li class="nav-item">
      <a class="nav-link" href="#" onclick="showOverview()">Overview</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" onclick="showComplaints()">My Complaints</a>
    </li>
    <li class="nav-item">
      <form action="{{ url_for('admin_complete') }}" method="POST">
    </li>
    <li class="nav-item">
      <a class="nav-link" href="{{ url_for('solution') }}">Give your solution here!</a>

    </li>

  </ul>
</nav>

<div class="app">


  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar" id="sidebar">

  <!-- Sidebar -->
  <aside class="sidebar">

    <h2 class="logo">Dashboard</h2>
    <ul>

      <li class="active">üè† Overview</li>
      <li>üìä Statistics</li>
      <li><a href="login.html">üîê Login</a></li>
      <li><a href="signuo.html">üìù Signup</a></li>
      <li><a href="index.html">üßæ Complaint</a></li>
      <li>üö™ Logout</li>
      <li class="active" onclick="showOverview()">üè† Overview</li>
      <li onclick="showComplaints()">üìã My Complaints</li>

      {% if session.get("user_role") == "user" %}
        <li>
          <a href="{{ url_for('index') }}">üßæ Submit Complaint</a>
        </li>
      {% endif %}


      <li>
        <a href="{{ url_for('logout') }}">üö™ Logout</a>
      </li>

      <li><a href="{{ url_for('logout') }}">üö™ Logout</a></li>
    </ul>
  </aside>

  <!-- ================= MAIN ================= -->
  <main>
    <header>
        <header>
  <input type="text" placeholder="Search..." />
  <div class="profile">
    <img id="userPhoto" src="user.png" alt="User">
    <span>Om</span>
  </div>
</header>

      
    </header>

    <section class="cards">
      <div class="card">Total Complaints<br><span>0</span></div>
      <div class="card green">Solved<br><span>0</span></div>
      <div class="card blue">Users<br><span>0</span></div>
    </section>


    <!-- HEADER -->
    <header class="dash-header d-flex justify-content-between align-items-center">
      <div class="profile" onclick="toggleProfileMenu()">
        <img src="{{ url_for('static', filename='user.png') }}" alt="User">
        <span>{{ session.get('user_role', 'User') }}</span>
      </div>
    </header>

    <!-- PROFILE MENU -->
    <div id="profileMenu" class="profile-menu">
      <div class="profile-header">
        <img src="{{ url_for('static', filename=user.profile_photo if user.profile_photo else 'user.png') }}" alt="User">

        <div>
          <b>{{ session.get('user_name','Citizen') }}</b><br>
          <small>{{ session.get('user_email','user@email.com') }}</small>
        </div>
      </div>

      <hr>

      <a href="{{ url_for('profile') }}">üë§ View Profile</a>
      <a href="{{ url_for('upload_photo') }}">üì∑ Add / Change Photo</a>
      <a href="{{ url_for('logout') }}">üö™ Logout</a>

      <hr>

      <form method="POST"
            action="{{ url_for('delete_account') }}"
            onsubmit="return confirm('Are you sure you want to delete your account?')">
        <button class="danger-btn">üóë Delete Account</button>
      </form>
    </div>

    <!-- ================= SUMMARY CARDS ================= -->
    <section class="cards">
      <div class="card">
        Total Complaints
        <span>{{ complaints|length }}</span>
      </div>

      <div class="card green">
        Approved
        <span>{{ complaints | selectattr("status","equalto","Approved") | list | length }}</span>
      </div>

      <div class="card blue">
        Pending
        <span>{{ complaints | selectattr("status","equalto","Pending") | list | length }}</span>
      </div>
    </section>

    <!-- ================= OVERVIEW ================= -->
    <section id="overviewSection" class="content">
      <div class="box">
        <h3>Monthly Complaints</h3>
        <canvas id="barChart"></canvas>
      </div>

      <div class="box">
        <h3>Status Distribution</h3>
        <canvas id="pieChart"></canvas>
      </div>
    </section>

    <!-- ================= MY COMPLAINTS ================= -->
    <section id="complaintsSection" class="content hidden">
      <div class="box full">
        <h3>My Complaints</h3>

        {% if complaints %}
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle mt-3">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Category</th>
                <th>Description</th>
                <th>Photo</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>Work Proof</th>
                <th>Rating</th>
                <th>Feedback</th>
                <th>Date</th>
                {% if is_admin %}
                  <th>Actions</th>
                {% endif %}
              </tr>
            </thead>

            <tbody>
              {% for c in complaints %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ c.category }}</td>
                <td>{{ c.description }}</td>

                <!-- PHOTO -->
                <td>
                  {% if c.image %}
                    <img src="{{ url_for('static', filename=c.image) }}" width="50" onclick="window.open(this.src)">
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>


                <!-- STATUS -->
                <td>
                  {% if c.status == "Pending" %}
                    <span class="badge bg-warning">Pending</span>
                  {% elif c.status == "In Progress" %}
                    <span class="badge bg-info">In Progress</span>
                  {% elif c.status == "Completed" %}
                    <span class="badge bg-primary">Completed</span>
                  {% elif c.status == "Approved" %}
                    <span class="badge bg-success">Approved</span>
                  {% endif %}
                </td>
    <!-- Complaint Table -->

    <section class="content">
      <div class="box" style="grid-column: 1 / -1;">
        <h3>Complaints</h3>


                <!-- ASSIGNED -->
                <td>{{ c.assigned_to or "Not Assigned" }}</td>

                <!-- WORK PROOF -->
                <td>
                  {% if c.work_image %}
                    <img src="{{ url_for('static', filename=c.work_image) }}" width="50" onclick="window.open(this.src)">
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <!-- RATING -->
                <td>
                  {% if c.rating %}
                    ‚≠ê {{ c.rating }}/5
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <!-- FEEDBACK -->
                <td>{{ c.feedback or "‚Äî" }}</td>

                <!-- DATE -->
                <td>{{ c.created_at.strftime("%d-%m-%Y") }}</td>

                <!-- ADMIN ACTIONS -->
                {% if is_admin %}
                <td>
                  {% if c.status == "Pending" %}
                    <a href="{{ url_for('assign_worker', id=c.id) }}" class="btn btn-sm btn-primary mb-1">
                      üë∑ Assign
                    </a>
                    <a href="{{ url_for('withdraw_history') }}" class="btn btn-outline-primary">
                      View Withdrawal History
                    </a>

                  {% elif c.status == "Completed" %}
                     <form action="{{ url_for('admin_complete') }}" method="POST" style="display:inline;">
                       <input type="hidden" name="id" value="{{ c.id }}">
                       <button type="submit" class="btn btn-sm btn-success">
                          ‚úÖ Approve
                       </button>
                      </form>


                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                {% endif %}
              </tr>

              <!-- USER FEEDBACK FORM -->
              {% if c.status == "Approved" and not c.rating and c.user_id == session.get("user_id") %}
              <tr>
                <td colspan="11">
                  <form method="POST"
                        action="{{ url_for('submit_feedback', id=c.id) }}"
                        class="d-flex gap-2">
                    <select name="rating" class="form-select w-auto" required>
                      <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                      <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                      <option value="3">‚≠ê‚≠ê‚≠ê</option>
                      <option value="2">‚≠ê‚≠ê</option>
                      <option value="1">‚≠ê</option>
                    </select>

                    <input type="text"
                           name="feedback"
                           class="form-control"
                           placeholder="Your feedback"
                           required>

                    <button class="btn btn-success">Submit</button>
                  </form>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% else %}
          <p class="text-muted">No complaints found.</p>
        {% endif %}
      </div>
    </section>

    {% if is_admin %}
    <hr>

    <!-- ================= WITHDRAW REQUESTS ================= -->
    <div class="box full mt-4">
      <h3>üí∞ Worker Withdrawal Requests</h3>

      {% if withdrawals %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle mt-3">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Worker ID</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody>
            {% for w in withdrawals %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ w.worker_id }}</td>
              <td>‚Çπ {{ w.amount }}</td>

              <td>
                {% if w.status == "Pending" %}
                  <span class="badge bg-warning">Pending</span>
                {% elif w.status == "Approved" %}
                  <span class="badge bg-success">Approved</span>
                {% elif w.status == "Rejected" %}
                  <span class="badge bg-danger">Rejected</span>
                {% endif %}
              </td>

              <td>{{ w.created_at.strftime("%d-%m-%Y") }}</td>

              <td>
                 {% if w.status == "Pending" %}

                   <form action="{{ url_for('approve_withdraw', id=w.id) }}"
                      method="POST"
                      style="display:inline;">
                     <button type="submit" class="btn btn-sm btn-success">
                       ‚úÖ Approve
                     </button>
                  </form>

                  <form action="{{ url_for('reject_withdraw', id=w.id) }}"
                    method="POST"
                    style="display:inline;">
                   <button type="submit" class="btn btn-sm btn-danger">
                      ‚ùå Reject
                   </button>
                 </form>

                {% else %}
                   ‚Äî
               {% endif %}
             </td>

            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted">No withdrawal requests.</p>
      {% endif %}
    </div>
    {% endif %}
    </section>
  </main>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="/static/js/dashboard.js"></script>
</body>
</html>


<!-- Dashboard JS -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
/* Sidebar Toggle */
document.getElementById("toggleBtn").addEventListener("click", function () {
  document.getElementById("sidebar").classList.toggle("collapsed");
});

/* Profile Menu */
function toggleProfileMenu() {
  document.getElementById("profileMenu").classList.toggle("show");
}

/* Sections */
function showOverview() {
  document.getElementById("overviewSection").classList.remove("hidden");
  document.getElementById("complaintsSection").classList.add("hidden");
}

function showComplaints() {
  document.getElementById("overviewSection").classList.add("hidden");
  document.getElementById("complaintsSection").classList.remove("hidden");
}
function showWithdrawals() {
  document.getElementById("overviewSection").classList.add("hidden");
  document.getElementById("complaintsSection").classList.add("hidden");
}
function showSolution() {
  document.getElementById("overviewSection").classList.add("hidden");
  document.getElementById("complaintsSection").classList.remove("hidden");
}
/* Click outside profile menu close */
document.addEventListener("click", function (e) {
  const menu = document.getElementById("profileMenu");
  const profile = document.querySelector(".profile");
  if (!profile.contains(e.target) && !menu.contains(e.target)) {
    menu.classList.remove("show");
  }
});
</script>

{% endblock %}

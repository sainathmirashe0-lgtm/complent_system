{% extends "base.html" %} {% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />

<div class="container-fluid">
    <!-- ================= HHS NAVBAR ================= -->
    <div class="hhs-navbar">
        <!-- LEFT TITLE -->
        <div class="hhs-title">Complaint Dashboard</div>

        <!-- RIGHT ACTION BUTTONS -->
        <div class="hhs-actions">
            <button class="hhs-btn active" onclick="showOverview()">Overview</button>

            <button class="hhs-btn" onclick="showComplaints()">All Complaints</button>

            {% if is_admin %}            
            <button class="hhs-btn warning"  onclick="showWithdrawals()">Workers Withdrawal</button>
            <!-- ===== LIVE WORKER STATUS ===== -->
            <div class="live-worker-box">
               <h3>üü¢ Live Worker Status</h3><ul id="workerList"></ul></div>

            {% endif %}
            {% if not user.is_blocked %}
              <a href="{{ url_for('solution') }}" class="hhs-btn success"> Give Solution </a>
              <a href="{{ url_for('index') }}" class="hhs-btn success">Add Complaints</a>
              <a href="{{ url_for('all_solutions') }}" class="hhs-btn success">view Solution</a>
            {% else %}
             <span class="hhs-btn disabled">üö´ Actions Disabled</span>
           {% endif %}

            <a href="{{ url_for('login') }}" class="hhs-btn success">logout </a>
            {% if is_user %}   
             <a href="{{ url_for('coupon') }}" class="btn btn-primary mt-2">üéÅ Go to Coupon & Redeem</a>
            {% endif %}
            <a href="{{ url_for('notifications') }}" class="btn btn-bell">üîî</a>


        </div>
    </div>
<div class="row g-3 align-items-stretch summary-row">

  <!-- Reward Points -->
  {% if is_user %}
  <div class="col-lg-3 col-md-6 col-sm-12">
    <div class="card reward-points-card h-100">
      <h6>Reward Points</h6>
      <h2>{{ user.reward_points }}</h2>
      <small>Use points to get discount</small>
    </div>
  </div>
  {% endif %}

  <!-- Total Complaints -->
  <div class="col-lg-3 col-md-6 col-sm-12">
    <div class="card p-3 h-100">
      <h6>Total Complaints</h6>
      <h2>{{ complaints|length }}</h2>
    </div>
  </div>

  <!-- Approved -->
  <div class="col-lg-3 col-md-6 col-sm-12">
    <div class="card p-3 h-100 bg-success text-white">
      <h6>Approved</h6>
      <h2>{{ complaints | selectattr("status","equalto","Approved") | list | length }}</h2>
    </div>
  </div>

  <!-- Pending -->
  <div class="col-lg-3 col-md-6 col-sm-12">
    <div class="card p-3 h-100 bg-warning">
      <h6>Pending</h6>
      <h2>{{ complaints | selectattr("status","equalto","Pending") | list | length }}</h2>
    </div>
  </div>

</div>

    <!-- ================= OVERVIEW ================= -->
    <div id="overviewSection">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card p-3 shadow-sm">
                    <h5>Monthly Complaints</h5>
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3 shadow-sm">
                    <h5>Status Distribution</h5>
                    <div class="chart-box">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MY COMPLAINTS ================= -->
    <div id="complaintsSection" class="d-none mt-5">
        <h4>My Complaints</h4>

        {% if complaints %}
        <div class="table-responsive mt-3">
            <table class="table table-bordered table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Photo</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Work Proof</th>
                        <th>Rating</th>
                        <th>Feedback</th>
                        <th>Date</th>
                        {% if is_admin %}
                        <th>Action</th>
                        {% endif %}
                    </tr>
                </thead>
                  <tbody>
{% for c in complaints %}
<tr>
  <td>{{ loop.index }}</td>
  <td>{{ c.category }}</td>
  <td>{{ c.description }}</td>

  <!-- PHOTO -->
  <td>
    {% if c.image %}
      <img src="{{ url_for('static', filename=c.image) }}"
           width="50"
           onclick="window.open(this.src)">
    {% else %}
      ‚Äî
    {% endif %}
  </td>

  <!-- STATUS -->
  <td>
    {% if c.status == "Pending" %}
      <span class="badge pending">Pending</span>

    {% elif c.status == "In Progress" %}
      <span class="badge in-progress">In Progress</span>

    {% elif c.status == "Completed" %}
      <span class="badge completed">Waiting Approval</span>

    {% elif c.status == "Approved" %}
      <span class="badge approved">Approved</span>

    {% elif c.status == "Rejected" %}
      <span class="badge bg-danger">Rejected</span>
      {% if c.reject_reason %}
        <br>
        <small class="text-danger">
          Reason: {{ c.reject_reason }}
        </small>
      {% endif %}
    {% endif %}
  </td>

  <!-- ASSIGNED -->
  <td>{{ c.assigned_to or "Not Assigned" }}</td>

  <!-- WORK PROOF -->
  <td>
    {% if c.work_image %}
      <img src="{{ url_for('static', filename=c.work_image) }}"
           width="50"
           onclick="window.open(this.src)">
    {% else %}
      ‚Äî
    {% endif %}
  </td>

  <!-- RATING -->
  <td>{{ c.rating or "‚Äî" }}</td>

  <!-- FEEDBACK -->
  <td>{{ c.feedback or "‚Äî" }}</td>

  <!-- DATE -->
  <td>{{ c.created_at.strftime("%d-%m-%Y") }}</td>

  <!-- ADMIN ACTION -->
  {% if is_admin %}
  <td>

    <!-- PENDING : ASSIGN + REJECT -->
    {% if c.status == "Pending" %}

      <a href="{{ url_for('assign_worker', id=c.id) }}"
         class="btn btn-sm btn-primary mb-1">
        Assign
      </a>

      <form method="POST"
            action="{{ url_for('admin_reject', complaint_id=c.id) }}"
            onsubmit="return confirm('Reject this complaint as FAKE?');">

        <textarea name="reason"
                  class="form-control form-control-sm mb-1"
                  placeholder="Reason (Fake complaint / false info)"
                  required></textarea>

        <button type="submit"
                class="btn btn-sm btn-danger w-100">
          Reject
        </button>
      </form>

    <!-- COMPLETED : APPROVE + REJECT -->
    {% elif c.status == "Completed" %}

      <form method="POST"
            action="{{ url_for('admin_approve', complaint_id=c.id) }}"
            class="mb-1"
            onsubmit="return confirm('Approve this work?');">
        <button type="submit"
                class="btn btn-sm btn-success w-100">
          Approve
        </button>
      </form>

      <form method="POST"
            action="{{ url_for('admin_reject', complaint_id=c.id) }}"
            onsubmit="return confirm('Reject this work as invalid?');">

        <textarea name="reason"
                  class="form-control form-control-sm mb-1"
                  placeholder="Reason (Bad work / fake proof)"
                  required></textarea>

        <button type="submit"
                class="btn btn-sm btn-danger w-100">
          Reject
        </button>
      </form>

    <!-- OTHERS -->
    {% else %}
      ‚Äî
    {% endif %}

  </td>
  {% endif %}
</tr>

<!-- ‚úÖ USER FEEDBACK (CORRECT PLACE) -->
{% if c.status == "Approved"
      and not c.rating
      and c.user_id == session.get("user_id") %}
<tr>
    <td colspan="11">
        <form method="POST" action="{{ url_for('submit_rating', complaint_id=c.id) }}">
            <select name="rating" class="form-select w-auto mb-2" required>
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="3">‚≠ê‚≠ê‚≠ê</option>
                <option value="2">‚≠ê‚≠ê</option>
                <option value="1">‚≠ê</option>
            </select>

            <input
                type="text"
                name="feedback"
                class="form-control mb-2"
                placeholder="Your feedback"
                required
            >

            <button class="btn btn-success btn-sm">Submit</button>
        </form>
    </td>
</tr>
{% endif %}


{% endfor %}
</tbody>

            </table>
        </div>
        {% else %}
        <p class="text-muted">No complaints found.</p>
        {% endif %}
    </div>
    <!-- ==================== WITHDRAWALS SECTION ==================== -->
{% if is_admin %}
<div id="withdrawSection" class="container-fluid mt-5 d-none">


  <div class="box full">
    <h3 class="mb-2">üí∞ Worker Withdrawal Requests</h3>
    <p class="text-muted mb-3">
      Review worker payout details carefully before approving.
    </p>

    {% if withdrawals %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>#</th>
            <th>Worker</th>
            <th>Payment Details</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
            <th>Admin Action</th>
          </tr>
        </thead>

        <tbody>
          {% for item in withdrawals %}

            {# ===== SAFE UNPACK ===== #}
            {% if item is iterable and item|length == 3 %}
              {% set w = item[0] %}
              {% set worker = item[1] %}
              {% set bank = item[2] %}
            {% else %}
              {% set w = item %}
              {% set worker = None %}
              {% set bank = None %}
            {% endif %}

            <tr>
              <!-- # -->
              <td class="text-center">{{ loop.index }}</td>

              <!-- WORKER -->
              <td>
                <b>ID:</b> {{ worker.id if worker else w.worker_id }}<br>
                <small class="text-muted">
                  {{ worker.name if worker and worker.name else 'Worker' }}
                </small>
              </td>

              <!-- PAYMENT DETAILS -->
              <td>
                {% if bank %}
                  <b>Bank:</b> {{ bank.bank_name }}<br>
                  <b>Account:</b> **** {{ bank.account_number[-4:] }}<br>
                  <b>IFSC:</b> {{ bank.ifsc_code }}
                {% else %}
                  <span class="text-muted">No bank details</span>
                {% endif %}
              </td>

              <!-- AMOUNT -->
              <td class="text-center">
                <span class="fw-bold text-success">‚Çπ {{ w.amount }}</span>
              </td>

              <!-- STATUS -->
              <td class="text-center">
                <span class="badge bg-warning text-dark">{{ w.status }}</span>
              </td>

              <!-- DATE -->
              <td class="text-center">
                {{ w.created_at.strftime('%d %b %Y') }}
              </td>

              <!-- ACTION -->
              <td>
                {% if w.status == 'Pending' %}
                <form method="POST"
                      action="{{ url_for('approve_withdraw', id=w.id) }}">
                  <input type="text"
                         name="payout_ref"
                         class="form-control form-control-sm mb-1"
                         placeholder="UTR"
                         required>
                  <button type="submit"
                          class="btn btn-success btn-sm w-100">
                    ‚úÖ Mark Paid
                  </button>
                </form>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>

          {% endfor %}
        </tbody>

      </table>
    </div>
    {% else %}
      <p class="text-muted text-center">No withdrawal requests.</p>
    {% endif %}
  </div>

</div>
{% endif %}


<!-- ================= PAGE JS ONLY ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
  function hideAll() {
    document.getElementById("overviewSection").classList.add("d-none");
    document.getElementById("complaintsSection").classList.add("d-none");
    const w = document.getElementById("withdrawSection");
    if (w) w.classList.add("d-none");
}

</script>
<script>
function loadLiveWorkers() {
  fetch("/api/workers/live-status")
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("workerList");
      if (!list) return;

      list.innerHTML = "";

      if (data.length === 0) {
        list.innerHTML = "<li>No workers online</li>";
        return;
      }

      data.forEach(w => {
        const li = document.createElement("li");
        li.innerHTML = `üü¢ ${w.name}`;
        list.appendChild(li);
      });
    });
}

// load immediately
loadLiveWorkers();

// refresh every 5 seconds
setInterval(loadLiveWorkers, 5000);
</script>


<script>
function showPayAnimation(form) {
  document.getElementById("payOverlay").style.display = "flex";

  setTimeout(() => {
    form.submit();
  }, 2500); // PhonePe style delay

  return false;
}
</script>

<script>
    function hideAll() {
        document.getElementById("overviewSection").classList.add("d-none");
        document.getElementById("complaintsSection").classList.add("d-none");
        const w = document.getElementById("withdrawSection");
        if (w) w.classList.add("d-none");
    }

    function showOverview() {
        hideAll();
        document.getElementById("overviewSection").classList.remove("d-none");
    }

    function showComplaints() {
        hideAll();
        document.getElementById("complaintsSection").classList.remove("d-none");
    }

    function showWithdrawals() {
        hideAll();
        document.getElementById("withdrawSection").classList.remove("d-none");
    }
</script>

{% endblock %}
